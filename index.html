<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.cdnfonts.com/css/atkinson-hyperlegible"
      rel="stylesheet"
    />
    <!-- Bootstrap -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

    <title>Carbon Footprint Calculator</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <h1>Carbon Footprint Estimator</h1>
    <!-- Transport -->
     <nav class="navbar navbar-inverse visible-xs">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>                        
          </button>
          <a class="navbar-brand" href="#">Logo</a>
        </div>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Dashboard</a></li>
            <li><a href="#">Age</a></li>
            <li><a href="#">Gender</a></li>
            <li><a href="#">Geo</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="inline-field">
      <h2>Transportation</h2>
      <p>Time length:</p>
      <select id="transport_timeframe" onchange="updateTimeframe(this)">
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <div id="transportEntriesContainer"></div>
    <div style="margin-top: 0.5em; text-align: center">
      <button type="button" class="button" onclick="addTransportEntry()">
        Add mode of transport
      </button>
    </div>

    <!-- Diet(s) -->
    <div class="inline-field">
      <h2>Diet</h2>
    </div>
    <button type="button" class="button" onclick="addDietEntry()">Add Diet</button>
    <div id="diet-container"></div>

    <!-- Food Waste -->
    <div class="inline-field">
      <h2>Food Waste</h2>
      <p>Time length:</p>
      <select id="foodwaste_timeframe" onchange="updateTimeframe(this)">
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <p>How much food waste do you throw away from your household?</p>
    <div class="inline-field">
      <label for="bread">Bread (kg thrown away):</label>
      <label for="produce">Produce (kg thrown away):</label>
      <label for="meat">Meat (kg thrown away):</label>
    </div>
    <div class="inline-field">
      <input type="number" id="trash-bread" />
      <input type="number" id="trash-produce" />
      <input type="number" id="trash-meat" />
    </div>
    <p>How much food waste do you compost from your household?</p>
    <div class="inline-field">
      <label for="bread">Bread (kg composted):</label>
      <label for="produce">Produce (kg composted):</label>
      <label for="meat">Meat (kg composted):</label>
    </div>
    <div class="inline-field">
      <input type="number" id="bread" />
      <input type="number" id="produce" />
      <input type="number" id="meat" />
    </div>
    <p>How much food waste do you compost from outside your household?</p>
    <div class="inline-field">
      <label for="bread">Bread (kg composted):</label>
      <label for="produce">Produce (kg composted):</label>
      <label for="meat">Meat (kg composted):</label>
    </div>
    <div class="inline-field">
      <input type="number" id="bread" />
      <input type="number" id="produce" />
      <input type="number" id="meat" />
    </div>

    <!-- Utilities -->
    <div class="inline-field">
      <h2>Utilities</h2>
      <p>Time length:</p>
      <select id="utilities_timeframe" onchange="updateTimeframe(this)">
        <option value="weekly">Weekly</option>
        <option value="monthly" selected>Monthly</option>
        <option value="yearly">Yearly</option>
      </select>
    </div>
    <label for="electricity"
      >How many kW do you use per
      <span class="timeframe" data-for="utilities_timeframe"></span>?
      <input
        type="number"
        id="electricity"
        style="display: inline-block; width: auto; margin-left: 0.5em"
      />
    </label>
    <label for="gas"
      >How many m<sup>3</sup> of natural gas do you use per
      <span class="timeframe" data-for="utilities_timeframe"></span>?
      <input
        type="number"
        id="gas"
        style="display: inline-block; width: auto; margin-left: 0.5em"
      />
    </label>
    <label for="water"
      >How many liters of water do you use per
      <span class="timeframe" data-for="utilities_timeframe"></span>?
      <input
        type="number"
        id="water"
        style="display: inline-block; width: auto; margin-left: 0.5em"
      />
    <label for="water"
      >Can you plz search on the internet for "kWh for 1 m^3 of water near me"? It's very local.
      <span class="timeframe" data-for="utilities_timeframe"></span>?
      <input
        type="number"
        id="waterEI"
        style="display: inline-block; width: auto; margin-left: 0.5em"
      />
    </label>
    <div class="inline-field">
      <p>Where do you get your utilities from?</p>
      <label for="country">Country:</label>
      <select id="country" onchange="updateRegions()">
        <option value="">-- Select Country --</option>
        <option value="USA">United States</option>
        <option value="CAN">Canada</option>
        <option value="MEX">Mexico</option>
        <option value="TAI">Taiwan</option>
        <option value="NET">Netherlands</option>
      </select>
      <label for="region">Region:</label>
      <select id="region">
        <option value="">-- Select Region --</option>
      </select>
    </div>

    <button class="button" onclick="calcFootprint()">
      Calculate Footprint
    </button>

    <div id="result"></div>
    <iframe 
        src="https://www.pik-potsdam.de/Carbonclock/Carbonclock.htm" 
        style="width: 600px; height: 340px; border: none;" 
        title="Carbon Clock by PIK Potsdam">
    </iframe>
    <p>If I can share anything with you, it is this: we can eliminate most of the sectors of all of our footprints through straightforward lifestyle choices (personal responsibility), collective action through activism, research and governmental policies. All it takes is for a large enough proportion of each country's population to care enough about human impact on the climate and biosphere that all our governments decide to change things.</p>
    <p>"No one is too small to make a difference" - Greta Thunburg</p>
    <p>Made by Jack Conneely.</p>
    <p>Source code: <a href="https://github.com/electricwapiti/Carbon-footprint-calculator">GitHub</a>"
    <p>Data sources: <a href="https://www.pik-potsdam.de/carbonclock">PIK Potsdam Carbon Clock</a></p>
    
    <script>
      // Transport entries management. I don't really understand it. TODO: learn what it is becasuse some code might not be necessary.
      let transportEntries = [];
      let nextTransportId = 1;
      function addTransportEntry() {
        const container = document.getElementById("transportEntriesContainer");
        const id = nextTransportId++;

        // Default entry object
        const entry = {
          id,
          mode: "car",
          distance: 0,
          fuelEfficiency: 0,
        };
        transportEntries.push(entry);

        const entryDiv = document.createElement("div");
        entryDiv.className = "transport-entry";
        entryDiv.id = `transport-${id}`;
        entryDiv.innerHTML = `
            <div class="transport-row">
              <label>
                  <select onchange="updateTransportMode(${id}, this.value)">
                      <option value="car">Car</option>
                      <option value="bus">Bus</option>
                      <option value="train">Train</option>
                      <option value="bike">Bicycle</option>
                      <option value="walk">Walking</option>
                  </select>
              </label>

              <label>
                  km last
                  <span class="timeframe" id="timeframe-${id}" data-for="transport_timeframe"></span>:
                  <input type="number" onchange="updateTransportDistance(${id}, this.value)">
              </label>

              <label id="fuel-eff-${id}">Fuel Efficiency (L/100km):
                  <input type="number" onchange="updateTransportFuel(${id}, this.value)">
              </label>

              <button type="button" class="button delete-button" onclick="removeTransportEntry(${id})">X</button>
            </div>
        `;
        container.appendChild(entryDiv);

        //Set the correct time length text for new entries
        const timeframeValue = document.getElementById(
          "transport_timeframe"
        ).value;
        let text = "week";
        if (timeframeValue === "monthly") text = "month";
        else if (timeframeValue === "yearly") text = "year";
        document.getElementById(`timeframe-${id}`).textContent = text;
      }

      //Keep your array in sync with the UI
      function updateTransportMode(id, mode) {
        const entry = transportEntries.find((e) => e.id === id);
        if (entry) entry.mode = mode;

        const fuelLabel = document.getElementById(`fuel-eff-${id}`);
        fuelLabel.style.display = mode === "car" ? "inline-block" : "none";
      }

      function updateTransportDistance(id, value) {
        const entry = transportEntries.find((e) => e.id === id);
        if (entry) entry.distance = parseFloat(value) || 0;
      }

      function updateTransportFuel(id, value) {
        const entry = transportEntries.find((e) => e.id === id);
        if (entry) entry.fuelEfficiency = parseFloat(value) || 0;
      }

      function removeTransportEntry(id) {
        transportEntries = transportEntries.filter((e) => e.id !== id);
        const entryDiv = document.getElementById(`transport-${id}`);
        if (entryDiv) entryDiv.remove();
      }

      function updateTransportInputs() {
        const transportType = document.getElementById("transportType").value;
        const carInputs = document.getElementById("carInputs");
        if (transportType === "car") {
          carInputs.style.display = "block";
        } else {
          carInputs.style.display = "none";
        }
      }

      // Diet entries management.
      // TODO: Treat diet entries as an array of objects including type, calories, and id. 
      // Use this to sum up the emissions of an entire household.
      let dietIdCounter = 0;
      function addDietEntry() {
        const id = dietIdCounter++;
        const container = document.getElementById("diet-container");
        const entryDiv = document.createElement("div");
        entryDiv.className = "diet-row";
        entryDiv.id = `diet-${id}`;

        entryDiv.innerHTML = `
        <label>Name:
          <input type="text" placeholder="Name" onchange="updateDietName(${id}, this.value)">
          </label>
            <label>Diet:
              <select onchange="updateDietType(${id}, this.value)">
                <option value="high_meat">High Meat Eater</option>
                <option value="average" selected>Average</option>
                <option value="pescitarian_w_s">Pescitarian w/ shrimp</option>
                <option value="pescitarian_wo_s">Pescitarian w/o shrimp</option>
                <option value="vegetarian">Vegetarian</option>
                <option value="vegan">Vegan</option>
              </select>
            </label>

              <label>
                Calories/day (kcal):
                <input type="number" onchange="updateDietCalories(${id}, this.value)">
              </label>

            <button type="button" class="button delete-button" onclick="removeDietEntry(${id})">X</button>
        `;
        container.appendChild(entryDiv);
      }

      function updateDietType(id, value) {
        console.log(`Diet ${id} set to: ${value}`);
        //TODO: Save or process the new diet type here as needed
      }

      function updateDietName(id, value) {
        console.log(`Diet ${id} name updated to: ${value}`);
        // TODO: Save or process the new name here as needed
      }

      function updateDietCalories(id, value) {
        console.log(`Diet ${id} calories updated to: ${value}`);
        // TODO: Save or process the new calories here as needed
      }
      
      function removeDietEntry(id) {
        const el = document.getElementById(`diet-${id}`);
        if (el) el.remove();
      }

      // Keep all the timeframe text in sync with the selected option
      function updateTimeframe(selectElement) {
        const value = selectElement.value;
        let text = "week";
        if (value === "monthly") text = "month";
        else if (value === "yearly") text = "year";
        const relatedSpan = document
          .querySelectorAll(`.timeframe[data-for="${selectElement.id}"]`)
          .forEach((span) => {
            span.textContent = text;
          });
      }

      //TODO: Make an array of diets and portion sizes (small, med, large). Use this to sum up the emissions of an entire household.
      function calcDiet() {
        const dietValue = document.getElementById("diet").value;

        const dietEmissionsMap = {
          high_meat: 40,
          average: 25,
          pescitarian_w_s: 22,
          pescitarian_wo_s: 18,
          vegetarian: 15,
          vegan: 12,
        };

        let dietCO2e = dietEmissionsMap[dietValue] || 0;
        return dietCO2e;
      }

      function calcTransit() {
        const timeframe = document.getElementById("transport_timeframe").value;

        // Emissions factors in kg CO2e per km
        const emissionsPerKm = {
          bus: 0.105,
          train: 0.041,
          bike: 0,
          walk: 0,
        };

        let transportCO2e = 0;

        for (const entry of transportEntries) {
          const km = entry.distance || 0;
          if (entry.mode === "car") {
            const litersUsed = (km / 100) * (entry.fuelEfficiency || 0);
            transportCO2e += litersUsed * 2.31;
          } else {
            transportCO2e += (emissionsPerKm[entry.mode] || 0) * km;
          }
        }

        transportCO2e = convertToYearly(timeframe, transportCO2e);
        return transportCO2e;
      }

      function calcFoodWaste() {
        // Placeholder — you'd insert your actual calculation logic
        return 0; // or some calculated number
      }

      // Calculate the CO2e emissions avoided by composting food waste from outside the household.
      // This is a societal emission reduction opportunity. TODO: add more opportunities (e.g. activism, lobbying, voting, donating, etc.) if you think of any.
      function calcCompostAvoided() {
        const bread = parseFloat(document.getElementById("bread").value) || 0;
        const produce =
          parseFloat(document.getElementById("produce").value) || 0;
        const meat = parseFloat(document.getElementById("meat").value) || 0;

        // Composting benefit: 100 yr CO2e of methane avoided
        const CH4_BREAD = 0.375;
        const CH4_PRODUCE = 0.25;
        const CH4_MEAT = 0.7;
        const ESCAPE_FACTOR = 0.61; // 61% escapes
        const GWP_100yr = 28;

        const compostCH4 =
          (bread * CH4_BREAD + produce * CH4_PRODUCE + meat * CH4_MEAT) *
          ESCAPE_FACTOR;

        let compostAvoidedCO2e = compostCH4 * GWP_100yr;

        //Find the selected timeframe and multiply it by that.
        const foodwasteTimeframe = document.getElementById(
          "foodwaste_timeframe"
        ).value;
        const yearlyEmissions = convertToYearly(foodwasteTimeframe);
        console.log("the food waste yearly emissions is" + yearlyEmissions);
        compostAvoidedCO2e = yearlyEmissions;
        return compostAvoidedCO2e;
      }

      function calcUtilities() {
        //get the values from the inputs
        //get the location selected for sources
        //read the specific region's CO2e intensity for each utility type from the JSON file
        //convert the input into kg CO2e
        //add & return the total emissions
        
        //get the values from the inputs
        const timeframe = document.getElementById("utilities_timeframe").value;
        const kWh = parseFloat(document.getElementById("electricity").value) || 0;
        const m3Gas = parseFloat(document.getElementById("gas").value) || 0;
        const litersWater = parseFloat(document.getElementById("water").value) || 0;

        // Get country and region from the DOM
        const country = document.getElementById("country").value;
        const region = document.getElementById("region").value;

        //Convert inputs to yearly emissions
        const yearlykWh = convertToYearly(timeframe, kWh);
        const yearlyGas = convertToYearly(timeframe, m3Gas);
        const yearlyWater = convertToYearly(timeframe, litersWater);
        console.log(
          `Yearly kWh: ${yearlykWh}, Yearly Gas: ${yearlyGas}, Yearly Water: ${yearlyWater}`
        );
        //Get region's electricity, gas, and water CO2e intensities
        const regionInfo = regionData[country]?.regions?.[region];
        const electricityIntensity = regionInfo.gCO2e_kWh * 0.001;
        const electricityCO2e = yearlykWh * electricityIntensity;
        //TODO:Find gas and water intensities, put em in the JSON file 

        //Calculate water emissions: 
        // CO2e intensity for H2O = H2O energy intensity * electricity carbon intensity + 30 g/m^3 (additives)
        const yearlyM3Water = yearlyWater * 0.001;
        //I had to ask for user input as its highly local :( 
        // TODO: compile a list of water EI values for different regions
        const waterEI = parseFloat(document.getElementById("waterEI").value) || 0; 
        const waterCO2e = yearlyM3Water * (waterEI * electricityIntensity + 0.03);


        //const gasIntensity = regionData[country].regions[region].gas;
        //const waterIntensity = regionData[country].regions[region].water;
        //For now, use placeholder values of "0.5" for gas and "0.1" for water
        const gasIntensity = 0.5; // kg CO2e per m3
        const waterIntensity = 0.1; // kg CO2e per liter
        const gasCO2e = yearlyGas * gasIntensity; //TODO: THIS IS A PLACEHOLDER VALUE, DO NOT USE IT IN PRODUCTION


        const totalUtilityCO2e = electricityCO2e + waterCO2e + gasCO2e;
        return totalUtilityCO2e;
      }
      /**
       * Convert the input value to yearly emissions based on the selected timeframe.
       * @param {string} timeframeElement - The selected timeframe (weekly, monthly, yearly).
       * @param {number} inputValue - The input value to convert.
       * @return {number} - The converted yearly emissions value.
       */
      function convertToYearly(timeframeElement, inputValue) {
        let yearlyEmissions = inputValue;
        if (timeframeElement === "weekly") {
          yearlyEmissions *= 52;
        } else if (timeframeElement === "monthly") {
          yearlyEmissions *= 12;
        }
        return yearlyEmissions;
      }

      function updateFoodFootprint() {
        const diet = document.getElementById("diet").value;
        let emissions = 0;
        switch (diet) {
          //TODO: do research about actual values
          case "high_meat":
            emissions = 40; //kg C02e per week
            break;
          case "average":
            emissions = 25; //kg C02e per week
            break;
          case "pescitarian_w_shrimp":
            emissions = 22; //kg C02e per week
            break;
          case "pescitarian_wo_shrimp":
            emissions = 18; //kg C02e per week
            break;
          case "vegetarian":
            emissions = 15; //kg C02e per week
            break;
          case "vegan":
            emissions = 12; //kg C02e per week
            break;
        }
      }

      /** CalcFootprint is the main fxn for calculating the footprint.
       *  It runs when the user presses the main calc footprint button.
       *  It calls other fxns for each sector before calling another fxn to output the data.
       * params: none
       * returns: none
       **/
      function calcFootprint() {
        //Verify that the user set enough data to calculate a footprint
        if (
          transportEntries.length === 0 ||
          document.getElementById("diet").value === "" ||
          document.getElementById("utilities_timeframe").value === "" ||
          document.getElementById("country").value === "" ||
          document.getElementById("region").value === ""
        ) {
          alert("Please fill in all required fields.");
          return;
        }

        transportCO2e = calcTransit();
        dietCO2e = calcDiet();
        // Water CO2e/L
        // Electricity CO2e/kWh
        // Gas CO2e/m3
        
        utilitiesCO2e = calcUtilities();
        console.log("Utilities CO2e: " + utilitiesCO2e);
        foodwasteCO2e = calcFoodWaste();
        compostAvoidedCO2e = calcCompostAvoided();

        const totalEmissions =
          transportCO2e +
          utilitiesCO2e +
          dietCO2e +
          foodwasteCO2e -
          compostAvoidedCO2e;
        document.getElementById("result").innerHTML = `
            <section class="result-section">
                Emissions from transportation: <span class="calc-value">${transportCO2e.toFixed(
                  2
                )} kg CO₂e</span><br/>
                Emissions from utilities: <span class="calc-value">${utilitiesCO2e.toFixed(
                  2
                )} kg CO₂e</span><br/>
                Emissions from food waste: <span class="calc-value">${foodwasteCO2e.toFixed(
                  2
                )} kg CO₂e</span><br/>
                Emissions avoided by extra composting: <span class="calc-value">${compostAvoidedCO2e.toFixed(
                  2
                )} kg CO₂e</span><br/>
                Emissions from diet: <span class="calc-value">${dietCO2e.toFixed(
                  2
                )} kg CO₂e</span><br/>
                <hr>
                <strong>Total carbon footprint: <span class="calc-value">${totalEmissions.toFixed(
                  2
                )} kg CO₂e</span></strong>
            </section>
        `;
      }
      function getRegionData() {
        // TODO: Implement a function to fetch and return region data
      }
      //Load & manage region CO2e emissions for utilities
      let regionData = {};

      window.addEventListener("DOMContentLoaded", () => {
        fetch("./intensities.json")
          .then((response) => response.json())
          .then((data) => {
            regionData = data.countries;
          })
          .catch(error => console.log("Error loading the JSON:", error))
      });

      function updateRegions() {
        const countrySelect = document.getElementById("country");
        const regionSelect = document.getElementById("region");
        const selectedCountry = countrySelect.value;
        regionSelect.innerHTML = "";
        // Add each region to the dropdown
        const regions = regionData[selectedCountry].regions;
        Object.keys(regions).forEach(region => {
            const option = document.createElement("option");
            option.value = region;
            option.textContent = region;
            regionSelect.appendChild(option);
        });
      }
    </script>
  </body>
</html>
